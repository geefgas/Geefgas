<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeefGas â€“ Examen</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="exam-data.js"></script>
</head>

<body class="theme examPage">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="examTop">
      <div class="examTop__title" id="examTitle">GeefGas â€“ Examen</div>
      <div class="pillTimer" id="timerPill">--:--</div>
    </div>
  </header>

  <!-- PAGE -->
  <main class="page">
    <div class="container page__inner">

      <!-- EXAM CARD -->
      <section class="examCard" id="examCard">

        <!-- MEDIA (foto bij vraag) -->
        <div class="examMedia" id="mediaWrap" style="display:none;">
          <img id="questionImage" alt="Afbeelding bij vraag"
               onerror="this.closest('.examMedia').style.display='none';" />
        </div>

        <!-- BODY -->
        <div class="examBody">
          <div class="examMeta">
            <div class="chip" id="chipTopic">Examen</div>
            <div class="muted" style="font-weight:900;" id="chipProgress">Vraag 1 van 1</div>
          </div>

          <h2 id="questionText">â€”</h2>

          <div class="answers" id="answers"></div>

          <!-- UITLEG (alleen bij directe feedback) -->
          <div class="explain" id="explainBox" style="display:none;">
            <div class="explainTitle" id="explainTitle">Uitleg</div>
            <div class="explainText" id="explainText"></div>
          </div>

          <div class="examFooter">
            <button class="btn btn--ghost" id="speakBtn" type="button">ðŸ”Š Voorlezen</button>

            <div class="examNavBtns">
              <button class="btn btn--ghost" id="prevBtn" type="button">Vorige</button>
              <button class="btn btn--gold" id="nextBtn" type="button">Volgende</button>
            </div>
          </div>

          <!-- Luxe norm-blok (ipv â€œMode: ... Norm: ...â€) -->
          <div class="ggNormNote" id="ggNormNote" style="margin-top:12px; display:none;">
            Je moet <span id="needCorrect">â€”</span> van de <span id="totalQs">â€”</span> vragen goed beantwoorden om te slagen.
          </div>

        </div>
      </section>

    </div>
  </main>

<script>
(function(){
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);

  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return `${m}:${s}`;
  }

  function safeStr(x){ return (x === null || x === undefined) ? "" : String(x); }

  function prettyTitle(t){
    // maakt "taxi-examen-1" -> "taxi examen 1" (zodat het niet zo â€œtechâ€ oogt)
    return safeStr(t).replace(/[_-]+/g, " ").replace(/\s+/g, " ").trim();
  }

  // ---------- settings ----------
  const revealMode = localStorage.getItem("gg_revealMode") || "instant"; // "instant" | "after"
  const ttsEnabled = (localStorage.getItem("gg_tts") || "0") === "1"; // optioneel

  // ---------- load exam ----------
  const examIdRaw = localStorage.getItem("gg_examId");
  const examNumber = Number(examIdRaw); // verwacht 1..15

  const exams = (window.EXAM_DATA && Array.isArray(window.EXAM_DATA.exams)) ? window.EXAM_DATA.exams : [];
  const exam = exams.find(e => String(e.id) === String(examIdRaw)) || null;

  if (!exam || !Array.isArray(exam.questions) || !exam.questions.length){
    alert("Geen examen gevonden. Ga terug en kies opnieuw een examen.");
    window.location.href = "examens.html";
    return;
  }

  const titleRaw = safeStr(exam.title || "Examen");
  const title = prettyTitle(titleRaw);
  const category = safeStr(exam.category || "Taxi");
  const durationMinutes = Number(exam.durationMinutes || 30);
  const total = exam.questions.length;

  document.title = `GeefGas â€“ ${title}`;
  $("examTitle").textContent = `GeefGas â€“ ${title}`;
  $("chipTopic").textContent = category;

  // norm / slagen
  const passMinCorrect = Number(exam.passMinCorrect || Math.ceil(total * 0.8));
  const maxMistakes = total - passMinCorrect;

  // toon luxe norm-blok
  $("needCorrect").textContent = String(passMinCorrect);
  $("totalQs").textContent = String(total);
  $("ggNormNote").style.display = "";

  // ---------- state ----------
  const questions = exam.questions.map(q => ({
    id: q.id,
    prompt: safeStr(q.prompt),
    options: Array.isArray(q.options) ? q.options.map(safeStr) : [],
    correctIndex: (typeof q.correctIndex === "number") ? q.correctIndex : null,
    explanation: safeStr(q.explanation || ""),
    // image support: q.image | q.imageUrl | q.img
    image: safeStr(q.image || q.imageUrl || q.img || "")
  }));

  let idx = 0;
  const attempt = new Array(total).fill(null); // chosen index per question
  let locked = false;

  // timer
  let remaining = durationMinutes * 60;
  $("timerPill").textContent = fmtTime(remaining);

  const timer = setInterval(() => {
    remaining -= 1;
    $("timerPill").textContent = fmtTime(remaining);
    if (remaining <= 0){
      clearInterval(timer);
      finishExam(true);
    }
  }, 1000);

  // ---------- AUTO IMAGE NAMING (voor alle examens / alle vragen) ----------
  // Verwacht: images/exams/taxi_e{EXAM}_q{01..40}.PNG
  function autoImagePathForCurrent(){
    const qNum = idx + 1;
    const qNum2 = String(qNum).padStart(2, "0");
    const eNum = (Number.isFinite(examNumber) && examNumber > 0) ? examNumber : 1;
    return `images/exams/taxi_e${eNum}_q${qNum2}.PNG`;
  }

  // ---------- render ----------
  function render(){
    const q = questions[idx];
    locked = false;
    $("explainBox").style.display = "none";
    $("explainBox").classList.remove("good","bad");

    $("chipProgress").textContent = `Vraag ${idx + 1} van ${total}`;
    $("questionText").textContent = q.prompt;

    // image
    // 1) als q.image in data staat -> die gebruiken
    // 2) anders -> automatisch pad gebruiken
    const imgPath = q.image || autoImagePathForCurrent();

    // We proberen altijd te laden; als bestand niet bestaat, onerror verbergt de hele blok (netjes)
    $("mediaWrap").style.display = "";
    $("questionImage").src = imgPath;

    // buttons
    $("prevBtn").disabled = (idx === 0);
    $("nextBtn").textContent = (idx === total - 1) ? "Afronden" : "Volgende";

    // answers
    const answersEl = $("answers");
    answersEl.innerHTML = "";

    const letters = ["A","B","C","D","E","F"];
    q.options.forEach((opt, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "answer";
      btn.innerHTML = `
        <span class="answerKey">${letters[i] || (i+1)}</span>
        <span>${opt}</span>
      `;

      // restore selection
      if (attempt[idx] === i) btn.classList.add("selected");

      btn.addEventListener("click", () => onChoose(i));
      answersEl.appendChild(btn);
    });

    // If mode is instant and already answered, we can show feedback again:
    if (revealMode !== "after" && attempt[idx] !== null){
      showInstantFeedback();
    }
  }

  function onChoose(choiceIndex){
    if (locked) return;
    attempt[idx] = choiceIndex;

    // update selected UI
    [...$("answers").children].forEach((el, i) => {
      el.classList.toggle("selected", i === choiceIndex);
      el.classList.remove("correct","wrong");
    });

    if (revealMode === "after"){
      // geen feedback, gewoon door
      return;
    }
    showInstantFeedback();
  }

  function showInstantFeedback(){
    const q = questions[idx];
    const chosen = attempt[idx];
    if (chosen === null) return;

    locked = true;

    const correctIndex = q.correctIndex;
    const nodes = [...$("answers").children];

    if (typeof correctIndex === "number"){
      nodes.forEach((el, i) => {
        if (i === correctIndex) el.classList.add("correct");
        if (i === chosen && chosen !== correctIndex) el.classList.add("wrong");
      });

      const ok = chosen === correctIndex;
      $("explainBox").style.display = q.explanation ? "" : "none";
      if (q.explanation){
        $("explainBox").classList.toggle("good", ok);
        $("explainBox").classList.toggle("bad", !ok);
        $("explainTitle").textContent = ok ? "Goed!" : "Fout";
        $("explainText").textContent = q.explanation;
      }
    }
  }

  // ---------- navigation ----------
  $("prevBtn").addEventListener("click", () => {
    if (idx > 0){
      idx -= 1;
      render();
    }
  });

  $("nextBtn").addEventListener("click", () => {
    if (idx === total - 1){
      finishExam(false);
      return;
    }
    idx += 1;
    render();
  });

  // ---------- speech ----------
  function speakCurrent(){
    const q = questions[idx];
    const chosen = attempt[idx];
    const lines = [];
    lines.push(q.prompt);
    q.options.forEach((opt, i) => lines.push(`${i+1}. ${opt}`));
    if (revealMode !== "after" && chosen !== null && typeof q.correctIndex === "number"){
      lines.push(chosen === q.correctIndex ? "Dit is correct." : "Dit is fout.");
      if (q.explanation) lines.push(q.explanation);
    }

    const text = lines.join(". ");
    if (!("speechSynthesis" in window)){
      alert("Voorlezen wordt niet ondersteund op dit toestel/browser.");
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "nl-NL";
    window.speechSynthesis.speak(u);
  }

  $("speakBtn").addEventListener("click", () => {
    // als jij voorlezen in instellingen wil afdwingen:
    // if (!ttsEnabled) { alert("Zet 'Voorlezen' aan in Instellingen."); return; }
    speakCurrent();
  });

  // ---------- finish ----------
  function finishExam(timeUp){
    clearInterval(timer);

    // score berekenen
    let correctCount = 0;
    const packedAttempt = questions.map((q, i) => {
      const chosen = (typeof attempt[i] === "number") ? attempt[i] : null;
      const correctIndex = (typeof q.correctIndex === "number") ? q.correctIndex : null;
      if (chosen !== null && correctIndex !== null && chosen === correctIndex) correctCount += 1;
      return { id: q.id, chosen, correctIndex };
    });

    const result = {
      examId: examIdRaw,
      title: title,
      category: category,
      total: total,
      correctCount: correctCount,
      passMinCorrect: passMinCorrect,
      durationMinutes: durationMinutes,
      timeUp: !!timeUp,
      revealMode: revealMode,
      attempt: packedAttempt,
      finishedAt: new Date().toISOString()
    };

    localStorage.setItem("gg_result", JSON.stringify(result));
    window.location.href = "resultaat.html";
  }

  // start
  render();

})();
</script>

</body>
</html>
