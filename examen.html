<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GeefGas â€“ Taxi Examen</title>

  <link rel="stylesheet" href="styles.css">
  <script src="exam-data.js"></script>
</head>

<body class="theme">

<header class="topbar">
  <div class="examTop">
    <div class="examTop__title" id="examTitle">GeefGas â€“ Taxi Examen</div>
    <div class="pillTimer" id="timer">25:00</div>
  </div>
</header>

<main class="page">
  <div class="container page__inner">

    <section class="examCard">

      <!-- VISUAL -->
      <div class="examMedia">
        <img id="qImage" src="assets/placeholder.jpg" alt="Visual bij vraag">
      </div>

      <!-- CONTENT -->
      <div class="examBody">

        <div class="examMeta">
          <span class="chip" id="categoryChip">Taxi</span>
          <span class="muted" id="progress">Vraag 1 van 40</span>
        </div>

        <h3 id="questionText">Ladenâ€¦</h3>

        <div id="answers" class="answers"></div>

        <div id="explainBox" class="explain" hidden>
          <div class="explainTitle" id="explainTitle"></div>
          <div class="explainText" id="explainText"></div>
        </div>

        <div class="examFooter">
          <button class="btn btn--ghost" id="readBtn">ðŸ”Š Voorlezen</button>
          <div style="display:flex; gap:10px;">
            <button class="btn btn--ghost" id="prevBtn">Vorige</button>
            <button class="btn btn--gold" id="nextBtn">Volgende</button>
          </div>
        </div>

        <p class="muted" id="modeHint" style="margin-top:12px;"></p>

      </div>
    </section>

  </div>
</main>

<script>
(function(){
  const PASS_PERCENT = 0.80;

  // ----------------------------
  // Helpers: safe access
  // ----------------------------
  function qsParam(name){
    try {
      const u = new URL(location.href);
      return u.searchParams.get(name);
    } catch { return null; }
  }

  function formatTime(sec){
    const m = String(Math.floor(sec / 60)).padStart(2,"0");
    const s = String(sec % 60).padStart(2,"0");
    return `${m}:${s}`;
  }

  function showFatal(msg){
    alert(msg);
    document.getElementById("questionText").textContent = msg;
  }

  // ----------------------------
  // Detect data model
  // Supports:
  //  A) legacy: EXAM_SETS + QUESTIONS
  //  B) newer: EXAM_DATA/EXAMS (list of exams with embedded questions)
  // ----------------------------
  const hasLegacy = (typeof window.EXAM_SETS !== "undefined") && (typeof window.QUESTIONS !== "undefined");
  const hasNew =
    (Array.isArray(window.EXAMS) && window.EXAMS.length) ||
    (window.EXAM_DATA && Array.isArray(window.EXAM_DATA.exams) && window.EXAM_DATA.exams.length);

  // ----------------------------
  // Read settings
  // ----------------------------
  const revealMode = localStorage.getItem("gg_revealMode") || "instant";
  const ttsEnabled = (localStorage.getItem("gg_ttsEnabled") || "false") === "true";

  // ----------------------------
  // Decide which exam to load
  // Priority:
  // 1) URL ?set=taxi_v1
  // 2) localStorage gg_examSet
  // 3) fallback to taxi_v1
  // 4) fallback to first available exam
  // ----------------------------
  const requestedSet = qsParam("set");
  const examSetId = requestedSet || localStorage.getItem("gg_examSet") || "taxi_v1";

  // ----------------------------
  // Build normalized exam object:
  // { title, durationSec, questions:[{question, answers[], correct, explanation, image, category}] }
  // ----------------------------
  let examTitleText = "Taxi Examen";
  let durationSec = 1500;
  let questions = [];

  if (hasLegacy) {
    const set = window.EXAM_SETS[examSetId] || window.EXAM_SETS["taxi_v1"];
    if (!set) {
      const keys = Object.keys(window.EXAM_SETS || {});
      if (!keys.length) return showFatal("Geen examensets gevonden in exam-data.js.");
      const fallback = window.EXAM_SETS[keys[0]];
      examTitleText = fallback?.title || "Taxi Examen";
      durationSec = fallback?.durationSec || 1500;
      questions = (fallback?.questionIds || [])
        .map(id => (window.QUESTIONS || []).find(q => q.id === id))
        .filter(Boolean);
    } else {
      examTitleText = set.title || "Taxi Examen";
      durationSec = set.durationSec || 1500;
      questions = (set.questionIds || [])
        .map(id => (window.QUESTIONS || []).find(q => q.id === id))
        .filter(Boolean);
    }
  } else if (hasNew) {
    const list = (Array.isArray(window.EXAMS) && window.EXAMS.length)
      ? window.EXAMS
      : (window.EXAM_DATA && Array.isArray(window.EXAM_DATA.exams) ? window.EXAM_DATA.exams : []);

    // try match by id
    let ex = list.find(e => (e.id || "").toLowerCase() === String(examSetId).toLowerCase());
    // if not found: take first exam
    if (!ex) ex = list[0];

    examTitleText = ex.title || "Taxi Examen";
    durationSec = (ex.durationMinutes ? ex.durationMinutes * 60 : 1500);

    questions = (ex.questions || []).map((q) => ({
      category: ex.category || q.category || "Taxi",
      question: q.prompt || q.question || "",
      answers: q.options || q.answers || [],
      correct: typeof q.correctIndex === "number" ? q.correctIndex : (typeof q.correct === "number" ? q.correct : 0),
      explanation: q.explanation || "",
      image: q.image || ""
    }));
  } else {
    return showFatal("exam-data.js bevat geen herkenbare examendata (EXAM_SETS/QUESTIONS of EXAM_DATA/EXAMS).");
  }

  if (!questions || questions.length === 0) {
    return showFatal("Geen vragen gevonden. Controleer exam-data.js.");
  }

  // ----------------------------
  // ELEMENTS
  // ----------------------------
  const examTitleEl = document.getElementById("examTitle");
  const timerEl     = document.getElementById("timer");
  const qImage      = document.getElementById("qImage");
  const questionTxt = document.getElementById("questionText");
  const answersDiv  = document.getElementById("answers");
  const progressEl  = document.getElementById("progress");
  const categoryEl  = document.getElementById("categoryChip");

  const explainBox  = document.getElementById("explainBox");
  const explainTit  = document.getElementById("explainTitle");
  const explainTxt  = document.getElementById("explainText");

  const prevBtn     = document.getElementById("prevBtn");
  const nextBtn     = document.getElementById("nextBtn");
  const readBtn     = document.getElementById("readBtn");
  const modeHint    = document.getElementById("modeHint");

  const total = questions.length;
  const requiredCorrect = Math.ceil(total * PASS_PERCENT);
  const maxMistakes = total - requiredCorrect;

  examTitleEl.textContent = `GeefGas â€“ ${examTitleText}`;
  modeHint.textContent =
    revealMode === "instant"
      ? `Mode: directe feedback â€¢ Norm: ${requiredCorrect}/${total} goed (max ${maxMistakes} fouten)`
      : `Mode: antwoorden pas na examen â€¢ Norm: ${requiredCorrect}/${total} goed (max ${maxMistakes} fouten)`;

  // Attempt structure
  const attempt = questions.map((q, idx) => ({
    idx,
    chosen: null,
    correct: q.correct
  }));

  // ----------------------------
  // TIMER
  // ----------------------------
  let time = durationSec;
  timerEl.textContent = formatTime(time);

  const timer = setInterval(() => {
    time--;
    if (time < 0) time = 0;
    timerEl.textContent = formatTime(time);
    if (time <= 0) finishExam();
  }, 1000);

  // ----------------------------
  // RENDER
  // ----------------------------
  let index = 0;

  function render(){
    const q = questions[index];

    categoryEl.textContent = q.category || "Taxi";
    progressEl.textContent = `Vraag ${index + 1} van ${total}`;
    questionTxt.textContent = q.question || "";

    qImage.onerror = () => { qImage.src = "assets/placeholder.jpg"; };
    qImage.src = q.image || "assets/placeholder.jpg";

    prevBtn.disabled = index === 0;
    nextBtn.textContent = index === total - 1 ? "Afronden" : "Volgende";

    answersDiv.innerHTML = "";
    explainBox.hidden = true;
    explainBox.className = "explain";

    (q.answers || []).forEach((txt, i) => {
      const btn = document.createElement("button");
      btn.className = "answer";
      btn.innerHTML = `<span class="answerKey">${String.fromCharCode(65+i)}</span>${txt}`;

      btn.onclick = () => {
        attempt[index].chosen = i;

        document.querySelectorAll(".answer").forEach(b =>
          b.classList.remove("selected","correct","wrong")
        );

        btn.classList.add("selected");

        if (revealMode === "instant") {
          if (i === q.correct) {
            btn.classList.add("correct");
            explainTit.textContent = "âœ… Goed";
            explainBox.classList.add("good");
          } else {
            btn.classList.add("wrong");
            const correctBtn = document.querySelectorAll(".answer")[q.correct];
            if (correctBtn) correctBtn.classList.add("correct");
            explainTit.textContent = "âŒ Niet goed";
            explainBox.classList.add("bad");
          }
          explainTxt.textContent = q.explanation || "";
          explainBox.hidden = false;
        }
      };

      answersDiv.appendChild(btn);
    });
  }

  // ----------------------------
  // VOORLEZEN
  // ----------------------------
  readBtn.onclick = () => {
    if (!ttsEnabled || !("speechSynthesis" in window)) return;

    const q = questions[index];
    const text = (q.question || "") + ". " + (q.answers || []).join(". ");
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "nl-NL";
    u.rate = 0.95;

    // Use saved best voice if exists (set by app.js)
    const preferred = localStorage.getItem("gg_voiceName");
    if (preferred) {
      const voices = speechSynthesis.getVoices();
      const match = voices.find(v => v.name === preferred);
      if (match) u.voice = match;
    }

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  };

  // ----------------------------
  // NAV
  // ----------------------------
  nextBtn.onclick = () => {
    if (index === total - 1) return finishExam();
    index++;
    render();
  };

  prevBtn.onclick = () => {
    if (index === 0) return;
    index--;
    render();
  };

  function finishExam(){
    clearInterval(timer);

    // Save result (compatible)
    const result = {
      examTitle: examTitleText,
      total,
      requiredCorrect,
      maxMistakes,
      attempt
    };
    localStorage.setItem("gg_result", JSON.stringify(result));

    window.location.href = "resultaat.html";
  }

  // START
  render();

})();
</script>

</body>
</html>
