<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeefGas â€“ Examen</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="exam-data.js"></script>
</head>

<body class="theme examPage">

  <!-- TOPBAR (luxe: logo + timer, geen lange titel) -->
  <header class="topbar">
    <div class="examTop">
      <a href="examens.html" aria-label="Terug naar examens" style="display:flex; align-items:center; gap:10px;">
        <img src="assets/geefgas.PNG" alt="GeefGas" style="height:22px; width:auto; display:block; opacity:.95;">
      </a>

      <div class="pillTimer" id="timerPill">--:--</div>
    </div>
  </header>

  <!-- PAGE -->
  <main class="page">
    <div class="container page__inner">

      <!-- EXAM CARD -->
      <section class="examCard" id="examCard">

        <!-- MEDIA (verschijnt zodra er een afbeelding is) -->
        <div class="examMedia" id="mediaWrap" style="display:none;">
          <img id="questionImage" alt="Afbeelding bij vraag"
               onerror="this.closest('.examMedia').style.display='none';" />
        </div>

        <!-- BODY -->
        <div class="examBody">
          <div class="examMeta">
            <div class="chip" id="chipTopic">Taxi</div>
            <div class="muted" style="font-weight:900;" id="chipProgress">Vraag 1 van 1</div>
          </div>

          <h2 id="questionText">â€”</h2>

          <div class="answers" id="answers"></div>

          <!-- UITLEG (alleen bij directe feedback) -->
          <div class="explain" id="explainBox" style="display:none;">
            <div class="explainTitle" id="explainTitle">Uitleg</div>
            <div class="explainText" id="explainText"></div>
          </div>

          <div class="examFooter">
            <button class="btn btn--ghost" id="speakBtn" type="button">ðŸ”Š Voorlezen</button>

            <div class="examNavBtns">
              <button class="btn btn--ghost" id="prevBtn" type="button">Vorige</button>
              <button class="btn btn--gold" id="nextBtn" type="button">Volgende</button>
            </div>
          </div>

          <!-- LUXE SLAGEN-BLOK (vervangt de lelijke Mode/Norm regel) -->
          <div id="passNote"
               style="
                 margin-top: 14px;
                 padding: 12px 12px;
                 border-radius: 16px;
                 border: 1px solid rgba(185,146,46,.22);
                 background: rgba(216,181,91,.10);
                 color: #2A2416;
                 font-weight: 850;
                 line-height: 1.55;
                 text-align: center;
               ">
            Je moet 0 van de 0 vragen goed beantwoorden om te slagen.
          </div>

        </div>
      </section>

    </div>
  </main>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = String(Math.floor(sec / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return `${m}:${s}`;
  }
  function safeStr(x){ return (x === null || x === undefined) ? "" : String(x); }

  // Instellingen
  const revealMode = localStorage.getItem("gg_revealMode") || "instant"; // "instant" | "after"

  // Examen laden
  const examId = localStorage.getItem("gg_examId");
  const exams = (window.EXAM_DATA && Array.isArray(window.EXAM_DATA.exams)) ? window.EXAM_DATA.exams : [];
  const exam = exams.find(e => String(e.id) === String(examId)) || null;

  if (!exam || !Array.isArray(exam.questions) || !exam.questions.length){
    alert("Geen examen gevonden. Ga terug en kies opnieuw een examen.");
    window.location.href = "examens.html";
    return;
  }

  const title = safeStr(exam.title || "Examen");
  const category = safeStr(exam.category || "Taxi");
  const durationMinutes = Number(exam.durationMinutes || 30);
  const total = exam.questions.length;

  document.title = `GeefGas â€“ ${title}`;
  $("chipTopic").textContent = category;

  // Norm / slagen -> luxe zin
  const passMinCorrect = Number(exam.passMinCorrect || Math.ceil(total * 0.8));
  $("passNote").textContent = `Je moet ${passMinCorrect} van de ${total} vragen goed beantwoorden om te slagen.`;

  // Vragen normaliseren
  const questions = exam.questions.map(q => ({
    id: q.id,
    prompt: safeStr(q.prompt),
    options: Array.isArray(q.options) ? q.options.map(safeStr) : [],
    correctIndex: (typeof q.correctIndex === "number") ? q.correctIndex : null,
    explanation: safeStr(q.explanation || ""),
    image: safeStr(q.image || q.imageUrl || q.img || "")
  }));

  let idx = 0;
  const attempt = new Array(total).fill(null);
  let locked = false;

  // Timer
  let remaining = durationMinutes * 60;
  $("timerPill").textContent = fmtTime(remaining);

  const timer = setInterval(() => {
    remaining -= 1;
    $("timerPill").textContent = fmtTime(remaining);
    if (remaining <= 0){
      clearInterval(timer);
      finishExam(true);
    }
  }, 1000);

  function render(){
    const q = questions[idx];
    locked = false;

    $("explainBox").style.display = "none";
    $("explainBox").classList.remove("good","bad");

    $("chipProgress").textContent = `Vraag ${idx + 1} van ${total}`;
    $("questionText").textContent = q.prompt;

    // Afbeelding
    if (q.image){
      $("mediaWrap").style.display = "";
      $("questionImage").src = q.image;
    } else {
      $("mediaWrap").style.display = "none";
      $("questionImage").removeAttribute("src");
    }

    // Nav buttons
    $("prevBtn").disabled = (idx === 0);
    $("nextBtn").textContent = (idx === total - 1) ? "Afronden" : "Volgende";

    // Antwoorden
    const answersEl = $("answers");
    answersEl.innerHTML = "";

    const letters = ["A","B","C","D","E","F"];
    q.options.forEach((opt, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "answer";
      btn.innerHTML = `
        <span class="answerKey">${letters[i] || (i+1)}</span>
        <span class="answerText" style="color: var(--text); font-weight: 900;">${opt}</span>
      `;

      if (attempt[idx] === i) btn.classList.add("selected");

      btn.addEventListener("click", () => onChoose(i));
      answersEl.appendChild(btn);
    });

    // Als al beantwoord + instant mode -> feedback terug tonen
    if (revealMode !== "after" && attempt[idx] !== null){
      showInstantFeedback();
    }
  }

  function onChoose(choiceIndex){
    if (locked) return;
    attempt[idx] = choiceIndex;

    [...$("answers").children].forEach((el, i) => {
      el.classList.toggle("selected", i === choiceIndex);
      el.classList.remove("correct","wrong");
    });

    if (revealMode === "after"){
      return; // geen feedback
    }
    showInstantFeedback();
  }

  function showInstantFeedback(){
    const q = questions[idx];
    const chosen = attempt[idx];
    if (chosen === null) return;

    locked = true;

    const correctIndex = q.correctIndex;
    const nodes = [...$("answers").children];

    if (typeof correctIndex === "number"){
      nodes.forEach((el, i) => {
        if (i === correctIndex) el.classList.add("correct");
        if (i === chosen && chosen !== correctIndex) el.classList.add("wrong");
      });

      const ok = chosen === correctIndex;
      $("explainBox").style.display = q.explanation ? "" : "none";
      if (q.explanation){
        $("explainBox").classList.toggle("good", ok);
        $("explainBox").classList.toggle("bad", !ok);
        $("explainTitle").textContent = ok ? "Goed!" : "Fout";
        $("explainText").textContent = q.explanation;
      }
    }
  }

  $("prevBtn").addEventListener("click", () => {
    if (idx > 0){
      idx -= 1;
      render();
    }
  });

  $("nextBtn").addEventListener("click", () => {
    if (idx === total - 1){
      finishExam(false);
      return;
    }
    idx += 1;
    render();
  });

  // Voorlezen
  function speakCurrent(){
    const q = questions[idx];
    const chosen = attempt[idx];
    const lines = [];
    lines.push(q.prompt);
    q.options.forEach((opt, i) => lines.push(`${i+1}. ${opt}`));

    if (revealMode !== "after" && chosen !== null && typeof q.correctIndex === "number"){
      lines.push(chosen === q.correctIndex ? "Dit is correct." : "Dit is fout.");
      if (q.explanation) lines.push(q.explanation);
    }

    const text = lines.join(". ");
    if (!("speechSynthesis" in window)){
      alert("Voorlezen wordt niet ondersteund op dit toestel/browser.");
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "nl-NL";
    window.speechSynthesis.speak(u);
  }

  $("speakBtn").addEventListener("click", () => speakCurrent());

  // Afronden
  function finishExam(timeUp){
    clearInterval(timer);

    let correctCount = 0;
    const packedAttempt = questions.map((q, i) => {
      const chosen = (typeof attempt[i] === "number") ? attempt[i] : null;
      const correctIndex = (typeof q.correctIndex === "number") ? q.correctIndex : null;
      if (chosen !== null && correctIndex !== null && chosen === correctIndex) correctCount += 1;
      return { id: q.id, chosen, correctIndex };
    });

    const result = {
      examId: examId,
      title: title,
      category: category,
      total: total,
      correctCount: correctCount,
      passMinCorrect: passMinCorrect,
      durationMinutes: durationMinutes,
      timeUp: !!timeUp,
      revealMode: revealMode,
      attempt: packedAttempt,
      finishedAt: new Date().toISOString()
    };

    localStorage.setItem("gg_result", JSON.stringify(result));
    window.location.href = "resultaat.html";
  }

  render();
})();
</script>

</body>
</html>
