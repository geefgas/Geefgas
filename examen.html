<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GeefGas â€“ Taxi Examen</title>

  <link rel="stylesheet" href="styles.css">
  <script src="exam-data.js"></script>
</head>

<body class="theme">

<header class="topbar">
  <div class="examTop">
    <div class="examTop__title" id="examTitle">GeefGas â€“ Taxi Examen</div>
    <div class="pillTimer" id="timer">25:00</div>
  </div>
</header>

<main class="page">
  <div class="container page__inner">

    <section class="examCard">

      <!-- VISUAL (met overlay hotspots) -->
      <div class="examMedia" style="position:relative;">
        <img id="qImage" src="assets/placeholder.jpg" alt="Visual bij vraag" style="display:block; width:100%; height:auto; border-radius:18px;">
        <div id="hotspotLayer" aria-label="Klik op de voertuigen" style="
          position:absolute; inset:0;
          pointer-events:none;
        "></div>
      </div>

      <!-- CONTENT -->
      <div class="examBody">

        <div class="examMeta">
          <span class="chip" id="categoryChip">Taxi</span>
          <span class="muted" id="progress">Vraag 1 van 40</span>
        </div>

        <h3 id="questionText">Ladenâ€¦</h3>

        <!-- status voor order-vraag -->
        <div id="orderStatus" class="muted" style="margin:8px 0 10px; font-weight:850; display:none;"></div>

        <div id="answers" class="answers"></div>

        <div id="explainBox" class="explain" hidden>
          <div class="explainTitle" id="explainTitle"></div>
          <div class="explainText" id="explainText"></div>
        </div>

        <div class="examFooter">
          <button class="btn btn--ghost" id="readBtn">ðŸ”Š Voorlezen</button>
          <div style="display:flex; gap:10px;">
            <button class="btn btn--ghost" id="prevBtn">Vorige</button>
            <button class="btn btn--gold" id="nextBtn">Volgende</button>
          </div>
        </div>

        <p class="muted" id="modeHint" style="margin-top:12px;"></p>

      </div>
    </section>

  </div>
</main>

<script>
(function(){
  const PASS_PERCENT = 0.80;

  const examSetId = localStorage.getItem("gg_examSet") || "taxi_v1";
  const set = (window.EXAM_SETS && window.EXAM_SETS[examSetId]) ? window.EXAM_SETS[examSetId] : null;

  if (!set) {
    alert("Examenset niet gevonden. Controleer EXAM_SETS in exam-data.js");
    return;
  }

  const revealMode = localStorage.getItem("gg_revealMode") || "instant";
  const ttsEnabled = (localStorage.getItem("gg_ttsEnabled") || "false") === "true";

  const questions = (set.questionIds || [])
    .map(id => (window.QUESTIONS || []).find(q => q.id === id))
    .filter(Boolean);

  if (!questions.length) {
    alert("Geen vragen gevonden. Controleer QUESTIONS in exam-data.js");
    return;
  }

  const total = questions.length;
  const requiredCorrect = Math.ceil(total * PASS_PERCENT);
  const maxMistakes = total - requiredCorrect;

  let index = 0;
  let time = set.durationSec || 1500;

  // per vraag bewaren we gekozen antwoord of gekozen volgorde
  const attempt = questions.map(q => ({
    id: q.id,
    type: q.type || "mcq",
    chosen: null,          // bij mcq: index
    chosenOrder: [],       // bij order: ["A","B","C"]
    correct: (typeof q.correct === "number" ? q.correct : null),
    correctOrder: Array.isArray(q.correctOrder) ? q.correctOrder : null
  }));

  // Elements
  const examTitle   = document.getElementById("examTitle");
  const timerEl     = document.getElementById("timer");
  const qImage      = document.getElementById("qImage");
  const questionTxt = document.getElementById("questionText");
  const answersDiv  = document.getElementById("answers");
  const progressEl  = document.getElementById("progress");
  const categoryEl  = document.getElementById("categoryChip");

  const explainBox  = document.getElementById("explainBox");
  const explainTit  = document.getElementById("explainTitle");
  const explainTxt  = document.getElementById("explainText");

  const prevBtn     = document.getElementById("prevBtn");
  const nextBtn     = document.getElementById("nextBtn");
  const readBtn     = document.getElementById("readBtn");
  const modeHint    = document.getElementById("modeHint");

  const hotspotLayer = document.getElementById("hotspotLayer");
  const orderStatus  = document.getElementById("orderStatus");

  examTitle.textContent = `GeefGas â€“ ${set.title || "Examen"}`;
  modeHint.textContent =
    revealMode === "instant"
      ? `Mode: directe feedback â€¢ Norm: ${requiredCorrect}/${total} goed (max ${maxMistakes} fouten)`
      : `Mode: antwoorden pas na examen â€¢ Norm: ${requiredCorrect}/${total} goed (max ${maxMistakes} fouten)`;

  // Timer
  function formatTime(sec){
    const m = String(Math.floor(sec / 60)).padStart(2,"0");
    const s = String(sec % 60).padStart(2,"0");
    return `${m}:${s}`;
  }
  timerEl.textContent = formatTime(time);

  const timer = setInterval(() => {
    time--;
    if (time < 0) time = 0;
    timerEl.textContent = formatTime(time);
    if (time <= 0) finishExam();
  }, 1000);

  // Image resolver (probeert meerdere varianten, voorkomt caching issues)
  function buildImageCandidates(rawPath){
    const candidates = [];
    const cacheBust = `?v=${Date.now()}`;

    function add(p){
      if (!p) return;
      const clean = p.replace(/\?.*$/, "");
      if (!candidates.includes(clean)) candidates.push(clean);
    }

    add(rawPath);

    const m = (rawPath || "").match(/(assets\/)(.*)$/i);
    if (m) {
      const tail = m[2];
      const base = tail.split("/").pop() || "";
      const dot = base.lastIndexOf(".");
      const name = dot > -1 ? base.slice(0, dot) : base;

      const exts = ["PNG","png","JPG","jpg","JPEG","jpeg","WEBP","webp"];

      for (const ext of exts) {
        add(`assets/${name}.${ext}`);
        add(`assets/examen1/${name}.${ext}`);
      }
      const upperName = name ? (name[0].toUpperCase() + name.slice(1)) : name;
      for (const ext of exts) {
        add(`assets/${upperName}.${ext}`);
        add(`assets/examen1/${upperName}.${ext}`);
      }
    }

    return candidates.map(p => p + cacheBust);
  }

  function setImageWithFallback(rawPath){
    const candidates = buildImageCandidates(rawPath || "");
    let i = 0;

    function tryNext(){
      if (i >= candidates.length) {
        qImage.src = "assets/placeholder.jpg";
        return;
      }
      qImage.src = candidates[i++];
    }

    qImage.onerror = tryNext;
    tryNext();
  }

  // ORDER helpers
  function clearHotspots(){
    hotspotLayer.innerHTML = "";
    hotspotLayer.style.pointerEvents = "none";
  }

  function setOrderStatus(text){
    orderStatus.style.display = "block";
    orderStatus.textContent = text;
  }

  function hideOrderStatus(){
    orderStatus.style.display = "none";
    orderStatus.textContent = "";
  }

  function renderOrderQuestion(q, state){
    // verberg MCQ antwoorden
    answersDiv.innerHTML = "";
    hideOrderStatus();

    // reset uitleg box
    explainBox.hidden = true;
    explainBox.className = "explain";

    const chosen = state.chosenOrder || [];
    setOrderStatus(`Gekozen volgorde: ${chosen.length ? chosen.join(" â†’ ") : "nog niets"} (klik op A/B/C in volgorde)`);

    // klikbare hotspots op foto
    clearHotspots();
    hotspotLayer.style.pointerEvents = "auto";

    const hs = Array.isArray(q.hotspots) ? q.hotspots : [];
    hs.forEach(h => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = h.label || h.key || "?";

      // luxe, duidelijk, groot tappunt
      btn.style.position = "absolute";
      btn.style.left = (h.x || 50) + "%";
      btn.style.top  = (h.y || 50) + "%";
      btn.style.transform = "translate(-50%, -50%)";
      btn.style.width = "54px";
      btn.style.height = "54px";
      btn.style.borderRadius = "999px";
      btn.style.border = "2px solid rgba(255,255,255,.85)";
      btn.style.background = "rgba(10,12,16,.72)";
      btn.style.color = "#fff";
      btn.style.fontWeight = "950";
      btn.style.fontSize = "18px";
      btn.style.boxShadow = "0 10px 24px rgba(0,0,0,.25)";
      btn.style.cursor = "pointer";

      // highlight als al gekozen
      const isChosen = chosen.includes(h.key);
      if (isChosen) {
        btn.style.background = "rgba(210,170,70,.85)"; // goud-achtig
        btn.style.color = "#0B0D12";
        btn.style.border = "2px solid rgba(0,0,0,.15)";
      }

      btn.onclick = () => {
        // al gekozen? negeer
        if ((state.chosenOrder || []).includes(h.key)) return;

        state.chosenOrder = [...(state.chosenOrder || []), h.key];

        // direct feedback (alleen wanneer order compleet is)
        const needLen = (q.correctOrder || []).length || 3;
        const now = state.chosenOrder.length;

        if (now < needLen) {
          setOrderStatus(`Gekozen volgorde: ${state.chosenOrder.join(" â†’ ")} (nog ${needLen - now})`);
          render(); // re-render om gekozen hotspots te highlighten
          return;
        }

        // nu compleet: controleren
        const correct = Array.isArray(q.correctOrder) ? q.correctOrder : [];
        const ok = state.chosenOrder.join("|") === correct.join("|");

        if (revealMode === "instant") {
          explainBox.hidden = false;
          if (ok) {
            explainTit.textContent = "âœ… Goed";
            explainBox.className = "explain good";
          } else {
            explainTit.textContent = "âŒ Niet goed";
            explainBox.className = "explain bad";
          }
          explainTxt.textContent = q.explanation || "";
        }

        setOrderStatus(`Jouw volgorde: ${state.chosenOrder.join(" â†’ ")} â€¢ Correct: ${correct.join(" â†’ ")}`);
        render(); // highlight
      };

      hotspotLayer.appendChild(btn);
    });

    // extra: reset-knop onderaan (alleen voor order)
    const resetBtn = document.createElement("button");
    resetBtn.type = "button";
    resetBtn.className = "btn btn--ghost";
    resetBtn.textContent = "â†º Opnieuw kiezen";
    resetBtn.style.marginTop = "12px";
    resetBtn.onclick = () => {
      state.chosenOrder = [];
      explainBox.hidden = true;
      explainBox.className = "explain";
      render();
    };

    answersDiv.appendChild(resetBtn);
  }

  function renderMcqQuestion(q, state){
    clearHotspots();
    hideOrderStatus();

    answersDiv.innerHTML = "";
    explainBox.hidden = true;
    explainBox.className = "explain";

    (q.answers || []).forEach((txt, i) => {
      const btn = document.createElement("button");
      btn.className = "answer";
      btn.innerHTML = `<span class="answerKey">${String.fromCharCode(65+i)}</span>${txt}`;

      // restore selection
      if (state.chosen === i) btn.classList.add("selected");

      btn.onclick = () => {
        state.chosen = i;

        document.querySelectorAll(".answer").forEach(b =>
          b.classList.remove("selected","correct","wrong")
        );

        btn.classList.add("selected");

        if (revealMode === "instant") {
          if (i === q.correct) {
            btn.classList.add("correct");
            explainTit.textContent = "âœ… Goed";
            explainBox.classList.add("good");
          } else {
            btn.classList.add("wrong");
            document.querySelectorAll(".answer")[q.correct]?.classList.add("correct");
            explainTit.textContent = "âŒ Niet goed";
            explainBox.classList.add("bad");
          }
          explainTxt.textContent = q.explanation || "";
          explainBox.hidden = false;
        }
      };

      answersDiv.appendChild(btn);
    });
  }

  // Render
  function render(){
    const q = questions[index];
    const state = attempt[index];

    categoryEl.textContent = q.category || "Taxi";
    progressEl.textContent = `Vraag ${index + 1} van ${total}`;
    questionTxt.textContent = q.question || "";

    setImageWithFallback(q.image);

    prevBtn.disabled = index === 0;
    nextBtn.textContent = index === total - 1 ? "Afronden" : "Volgende";

    if ((q.type || "mcq") === "order") {
      renderOrderQuestion(q, state);
    } else {
      renderMcqQuestion(q, state);
    }
  }

  // Voorlezen
  readBtn.onclick = () => {
    if (!ttsEnabled || !("speechSynthesis" in window)) return;
    const q = questions[index];

    let text = (q.question || "");
    if ((q.type || "mcq") === "mcq") {
      text += ". " + (q.answers || []).join(". ");
    } else {
      text += ". Klik op A, B en C in de juiste volgorde.";
    }

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "nl-NL";
    u.rate = 0.95;

    const preferred = localStorage.getItem("gg_voiceName");
    if (preferred) {
      const voices = speechSynthesis.getVoices();
      const match = voices.find(v => v.name === preferred);
      if (match) u.voice = match;
    }

    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  };

  // Nav
  nextBtn.onclick = () => {
    if (index === total - 1) return finishExam();
    index++;
    render();
  };

  prevBtn.onclick = () => {
    if (index === 0) return;
    index--;
    render();
  };

  function finishExam(){
    clearInterval(timer);
    localStorage.setItem("gg_result", JSON.stringify({
      total,
      requiredCorrect,
      maxMistakes,
      attempt
    }));
    window.location.href = "resultaat.html";
  }

  render();
})();
</script>

</body>
</html>
