<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GeefGas ‚Äì Resultaat</title>
  <link rel="stylesheet" href="styles.css">
  <script src="exam-data.js"></script>
</head>

<body class="theme">

<header class="topbar">
  <div class="container topbar__inner">
    <a class="brand" href="index.html" aria-label="GeefGas Home">
      <img class="brand__logo" src="assets/geefgas.png" alt="GeefGas logo" />
      <span class="brand__name">GeefGas</span>
    </a>
    <a class="nav__cta" href="examens.html">Nieuw examen</a>
  </div>
</header>

<main class="page">
  <div class="container page__inner">

    <section class="card">
      <h2 style="margin:0 0 6px;">Resultaat</h2>
      <p class="muted" id="resultText" style="margin:0; line-height:1.6;"></p>
      <div id="passBox" class="note" style="margin-top:12px;"></div>
    </section>

    <section class="card" id="reviewPanel">
      <h3 style="margin:0 0 10px;">Fouten + uitleg</h3>
      <div id="reviewList"></div>
    </section>

    <section class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn--gold" href="examens.html">Nieuw examen</a>
        <a class="btn btn--ghost" href="index.html">Home</a>
      </div>
    </section>

  </div>
</main>

<script>
(function(){
  function esc(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---- Nieuw formaat (uit onze nieuwe examen.html) ----
  let result = null;
  try {
    const raw = localStorage.getItem("gg_result");
    if (raw) result = JSON.parse(raw);
  } catch(e){ result = null; }

  // Fallback: als er nog oude keys bestaan (voor het geval dat)
  // (We tonen dan "Geen score gevonden" i.p.v. crash)
  const mode = localStorage.getItem("gg_revealMode") || "instant";

  const resultText = document.getElementById("resultText");
  const passBox = document.getElementById("passBox");
  const reviewPanel = document.getElementById("reviewPanel");
  const reviewList = document.getElementById("reviewList");

  if (!result || !result.total) {
    resultText.textContent = "Geen resultaat gevonden. Start opnieuw een examen.";
    passBox.innerHTML = "<strong>Geen score gevonden.</strong><br>Ga terug naar examens en start opnieuw.";
    reviewPanel.style.display = "none";
    return;
  }

  const examId = result.examId || "";
  const title = result.title || "Examen";
  const total = Number(result.total || 0);
  const passMinCorrect = Number(result.passMinCorrect || Math.ceil(total * 0.8));
  const correctCount = Number(result.correctCount || 0);
  const maxMistakes = total - passMinCorrect;
  const passed = correctCount >= passMinCorrect;

  resultText.textContent =
    `${title} ‚Ä¢ Score: ${correctCount} van ${total}` +
    (mode === "after" ? " ‚Ä¢ Antwoorden pas na examen" : " ‚Ä¢ Directe feedback");

  if (passed) {
    passBox.innerHTML =
      `<strong>‚úÖ Geslaagd!</strong><br>` +
      `Minimaal <strong>${passMinCorrect}</strong> goed nodig. ` +
      `Maximaal <strong>${maxMistakes}</strong> fouten toegestaan.`;
  } else {
    passBox.innerHTML =
      `<strong>‚ùå Gezakt</strong><br>` +
      `Minimaal <strong>${passMinCorrect}</strong> goed nodig. ` +
      `Maximaal <strong>${maxMistakes}</strong> fouten toegestaan.`;
  }

  // ---- Vragen opzoeken in EXAM_DATA ----
  const exams = (window.EXAM_DATA && Array.isArray(window.EXAM_DATA.exams)) ? window.EXAM_DATA.exams : [];
  const exam = exams.find(e => e.id === examId) || null;

  // Als exam niet gevonden, toon alleen score
  if (!exam || !Array.isArray(exam.questions)) {
    reviewPanel.style.display = "none";
    return;
  }

  // Maak snelle lookup
  const qMap = new Map();
  exam.questions.forEach(q => qMap.set(String(q.id), q));

  const attempt = Array.isArray(result.attempt) ? result.attempt : [];
  const wrong = attempt
    .map(a => {
      const q = qMap.get(String(a.id));
      if (!q) return null;
      const chosen = (typeof a.chosen === "number") ? a.chosen : null;
      const correctIndex = (typeof q.correctIndex === "number") ? q.correctIndex : (typeof a.correctIndex === "number" ? a.correctIndex : null);
      const isWrong = (chosen === null) ? true : (correctIndex !== null && chosen !== correctIndex);
      return { a, q, chosen, correctIndex, isWrong };
    })
    .filter(x => x && x.isWrong);

  if (!wrong.length) {
    reviewList.innerHTML = `
      <div style="border:1px solid rgba(16,19,26,.12); border-radius:16px; padding:14px; background:#fff;">
        <div style="font-weight:950; margin-bottom:6px;">Top! üéâ Alles goed.</div>
        <div class="muted" style="line-height:1.6;">Blijf herhalen om het vast te houden.</div>
      </div>
    `;
    return;
  }

  // Render foutenlijst
  reviewList.innerHTML = "";
  wrong.forEach((item, idx) => {
    const q = item.q;
    const chosen = item.chosen;
    const correctIndex = item.correctIndex;

    const chosenText =
      (chosen === null) ? "(geen antwoord)" :
      (Array.isArray(q.options) && q.options[chosen]) ? q.options[chosen] : "(onbekend)";

    const correctText =
      (correctIndex === null) ? "(onbekend)" :
      (Array.isArray(q.options) && q.options[correctIndex]) ? q.options[correctIndex] : "(onbekend)";

    const block = document.createElement("div");
    block.style.border = "1px solid rgba(16,19,26,.12)";
    block.style.borderRadius = "16px";
    block.style.padding = "14px";
    block.style.background = "#fff";
    block.style.marginBottom = "12px";

    block.innerHTML = `
      <div style="font-weight:950; margin-bottom:6px;">Vraag ${idx + 1}</div>
      <div style="font-weight:900; line-height:1.55; margin-bottom:10px;">${esc(q.prompt)}</div>

      <div style="line-height:1.6;">
        <div><strong>Jouw antwoord:</strong> <span style="color:#b42318; font-weight:900;">${esc(chosenText)}</span></div>
        <div><strong>Goed antwoord:</strong> <span style="color:#067647; font-weight:900;">${esc(correctText)}</span></div>
        ${q.explanation ? `<div style="margin-top:10px;"><strong>Uitleg:</strong> <span class="muted" style="font-weight:750;">${esc(q.explanation)}</span></div>` : ""}
      </div>
    `;

    reviewList.appendChild(block);
  });

})();
</script>

</body>
</html>
