ame: Generate ElevenLabs Audio

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate audio (first batch)
        env:
          ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
          ELEVEN_VOICE_ID: ${{ secrets.ELEVEN_VOICE_ID }}
        run: |
          node -e "
          const fs=require('fs');
          const fetch=global.fetch;

          const key=process.env.ELEVEN_API_KEY;
          const voice=process.env.ELEVEN_VOICE_ID;
          if(!key || !voice) throw new Error('Missing ELEVEN_API_KEY or ELEVEN_VOICE_ID');

          const bankPath='assets/vragen.json';
          if(!fs.existsSync(bankPath)) throw new Error('Missing assets/vragen.json');

          const bank=JSON.parse(fs.readFileSync(bankPath,'utf8'));
          fs.mkdirSync('assets/audio',{recursive:true});

          const pad=n=>String(n).padStart(4,'0');

          async function tts(text){
            const r=await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice}`,{
              method:'POST',
              headers:{
                'xi-api-key':key,
                'Content-Type':'application/json',
                'Accept':'audio/mpeg'
              },
              body:JSON.stringify({
                text,
                model_id:'eleven_multilingual_v2',
                voice_settings:{
                  stability: 0.6,
                  similarity_boost: 0.8,
                  style: 0.25,
                  use_speaker_boost: true
                }
              })
            });
            if(!r.ok){
              const err=await r.text();
              throw new Error(`ElevenLabs ${r.status}: ${err}`);
            }
            return Buffer.from(await r.arrayBuffer());
          }

          // ðŸ‘‰ hier kun je later 100 / 300 / 600 van maken
          const LIMIT = 20;

          (async()=>{
            for(let i=0;i<Math.min(LIMIT, bank.length);i++){
              const q=bank[i];
              const file=`q_${pad(q.id)}.mp3`;
              const out=`assets/audio/${file}`;

              if(fs.existsSync(out)){
                q.audio = q.audio || out;
                continue;
              }

              const txt =
                `${q.vraag}\n\n` +
                `Antwoord A: ${q.opties[0]}.\n\n` +
                `Antwoord B: ${q.opties[1]}.\n\n` +
                `Antwoord C: ${q.opties[2]}.`;

              const audio = await tts(txt);
              fs.writeFileSync(out, audio);
              q.audio = out;
              console.log('Saved', out);
            }

            fs.writeFileSync(bankPath, JSON.stringify(bank, null, 2));
          })().catch(e=>{ console.error(e); process.exit(1); });
          "

      - name: Commit & push generated audio
        run: |
          git config user.name "geefgas-bot"
          git config user.email "actions@users.noreply.github.com"
          git add assets/audio assets/vragen.json
          git commit -m "Generate ElevenLabs audio" || echo "Nothing to commit"
          git push
