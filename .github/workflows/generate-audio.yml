name: Generate ElevenLabs Audio

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate audio (batch)
        env:
          ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
          ELEVEN_VOICE_ID: ${{ secrets.ELEVEN_VOICE_ID }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const API_KEY = process.env.ELEVEN_API_KEY;
          const VOICE_ID = process.env.ELEVEN_VOICE_ID;

          if (!API_KEY || !VOICE_ID) {
            throw new Error("Missing ELEVEN_API_KEY or ELEVEN_VOICE_ID");
          }

          const bankPath = path.join('assets','vragen.json');
          if (!fs.existsSync(bankPath)) {
            throw new Error("Missing assets/vragen.json");
          }

          const outDir = path.join('assets','audio');
          fs.mkdirSync(outDir, { recursive: true });

          const bank = JSON.parse(fs.readFileSync(bankPath, 'utf8'));

          function pad4(n){ return String(n).padStart(4,'0'); }

          async function tts(text){
            const url = `https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`;
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'xi-api-key': API_KEY,
                'Content-Type': 'application/json',
                'Accept': 'audio/mpeg'
              },
              body: JSON.stringify({
                text,
                model_id: 'eleven_multilingual_v2',
                voice_settings: {
                  stability: 0.6,
                  similarity_boost: 0.8,
                  style: 0.25,
                  use_speaker_boost: true
                }
              })
            });

            if(!res.ok){
              const err = await res.text();
              throw new Error(`ElevenLabs ${res.status}: ${err}`);
            }

            return Buffer.from(await res.arrayBuffer());
          }

          // âœ… Begin klein. Als dit werkt, zet je dit naar 100 / 300 / 600
          const LIMIT = 20;

          (async () => {
            for(let i=0; i<Math.min(LIMIT, bank.length); i++){
              const q = bank[i];

              // Zorg dat q.id bestaat. Als je vragen geen id hebben:
              // vervang q.id hieronder door (i+1)
              const id = q.id ?? (i+1);

              const file = `q_${pad4(id)}.mp3`;
              const outFile = path.join(outDir, file);

              if(fs.existsSync(outFile)){
                q.audio = q.audio || `assets/audio/${file}`;
                continue;
              }

              if(!q.vraag || !q.opties || q.opties.length < 3){
                console.log("Skip invalid question at index", i);
                continue;
              }

              const text =
                `${q.vraag}\n\n` +
                `Antwoord A: ${q.opties[0]}.\n\n` +
                `Antwoord B: ${q.opties[1]}.\n\n` +
                `Antwoord C: ${q.opties[2]}.`;

              console.log("Generating", file);
              const audio = await tts(text);
              fs.writeFileSync(outFile, audio);

              q.audio = `assets/audio/${file}`;
            }

            fs.writeFileSync(bankPath, JSON.stringify(bank, null, 2), 'utf8');
          })().catch(e => { console.error(e); process.exit(1); });
          NODE

      - name: Commit & push generated audio
        run: |
          git config user.name "geefgas-bot"
          git config user.email "actions@users.noreply.github.com"
          git add assets/audio assets/vragen.json
          git commit -m "Generate ElevenLabs audio" || echo "Nothing to commit"
          git push
